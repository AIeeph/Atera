<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart - Atera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Momo+Trust+Display&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #fff; font-family: 'Momo Trust Display', sans-serif; }
    header { background-color: #1e1e1e; padding: 10px 0; }
    .profile { display: flex; align-items: center; margin-bottom: 30px; }
    .profile img { width: 80px; height: 80px; border-radius: 50%; margin-right: 20px; border: 2px solid #fff; }
    .profile h2 { margin: 0; }
    .game-card { background-color: #1f1f1f; border-radius: 8px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; display: flex; align-items: center; padding: 10px; margin-bottom: 15px; }
    .game-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,255,255,0.3); }
    .game-card img { width: 80px; height: 80px; border-radius: 5px; object-fit: cover; margin-right: 15px; }
    .game-info { flex: 1; }
    .game-info h5 { margin: 0 0 5px 0; }
    .game-info p { margin: 0; color: #aaa; }
    .btn-remove { background-color: #ff4d4d; border: none; color: #fff; transition: 0.2s; }
    .btn-remove:hover { background-color: #ff1a1a; }
    .cart-container { max-width: 800px; margin: auto; padding: 20px; }
    footer { text-align: center; padding: 15px 0; background-color: #1e1e1e; margin-top: 50px; }
    
  </style>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function () {
      emailjs.init({
        publicKey: "MpvXPonhsQZCp8DBc",
      });
    })();
  </script>
</head>
<body>

  <header class="bg-dark text-white p-3 sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="index.html" class="d-flex align-items-center text-white text-decoration-none">
                <img src="images/logo.png" alt="Atera Logo" style="height: 50px; margin-right: 10px;">
                <h2 class="m-0">Atera</h2>
            </a>

            <nav class="ms-auto">
                <ul class="nav">
                    <li class="nav-item"><a href="index.html" class="nav-link text-white">Browse</a></li>
                    <li class="nav-item"><a href="products.html" class="nav-link text-white">Recommendations</a></li>
                    <li class="nav-item"><a href="categories.html" class="nav-link text-white">Categories</a></li>
                    <li class="nav-item position-relative">
  <a href="cart.html" class="nav-link text-white">
    <i class="bi bi-cart3"></i>
    <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      0
    </span>
  </a>
</li>

                    <li class="nav-item"><a href="contact.html" class="nav-link text-white active">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>


<main class="cart-container">
  <div class="profile">
    <img src="images/avatar.jpg" alt="User Avatar">
    <div>
      <h2>Aleph</h2>
      <p>Level 27 | 1500 XP</p>
    </div>
  </div>

  <h3>Your Games in Cart</h3>
  <div id="cartGames"></div>
  <div class="d-flex justify-content-end mt-3">
    <button id="checkoutBtn" class="btn btn-primary">Checkout</button>
  </div>
  <div id="checkoutMsg" class="mt-3"></div>

  <h3 class="mt-5">Played Games</h3>
<div id="playedGames"></div>


</main>

<footer>
  <p>© 2025 Atera — All rights reserved</p>
</footer>



<script>
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const cartContainer = document.getElementById('cartGames');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const checkoutMsg = document.getElementById('checkoutMsg');
  const cartCount = document.getElementById('cartCount');

  function renderCart() {
    cartContainer.innerHTML = '';
    if (cart.length === 0) {
      cartContainer.innerHTML = '<p class="text-center text-muted mt-3">Your cart is empty.</p>';
      return;
    }
    cart.forEach((game, index) => {
      const card = document.createElement('div');
      card.className = 'game-card';
      const priceText = game.price != null ? `${Number(game.price).toFixed(2)}$` : '';
      card.innerHTML = `
        <img src="${game.img}" alt="${game.title}">
        <div class="game-info">
          <h5>${game.title}</h5>
          <p>${priceText}</p>
        </div>
        <button class="btn btn-remove" onclick="removeFromCart(${index})">Remove</button>
      `;
      cartContainer.appendChild(card);
    });
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    updateCartCount();
  }

  function updateCartCount() {
    cartCount.textContent = cart.length;
  }

  async function checkout() {
    checkoutMsg.textContent = '';
    checkoutMsg.className = 'mt-3';

    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!token || !user?.email) {
      checkoutMsg.textContent = 'Please login first.';
      checkoutMsg.classList.add('text-danger');
      return;
    }

    if (cart.length === 0) {
      checkoutMsg.textContent = 'Cart is empty.';
      checkoutMsg.classList.add('text-danger');
      return;
    }

    const orderResults = await Promise.allSettled(
      cart.map((game) =>
        fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ game_id: game._id })
        })
      )
    );

    const failed = orderResults.some((r) => r.status === 'rejected' || (r.value && !r.value.ok));
    if (failed) {
      checkoutMsg.textContent = 'Order failed. Try again.';
      checkoutMsg.classList.add('text-danger');
      return;
    }

    const titles = cart.map((g) => g.title).join(', ');
    try {
      const orderId = `${Date.now()}`;
      await emailjs.send('service_yjk1gme', 'template_swny45e', {
        order_id: orderId,
        email: user.email
      });
    } catch {
      // email failure shouldn't block purchase
    }

    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    updateCartCount();
    checkoutMsg.textContent = 'Order placed.';
    checkoutMsg.classList.add('text-success');
  }

  checkoutBtn.addEventListener('click', checkout);
  renderCart();
  updateCartCount();
</script>

</body>
</html>

